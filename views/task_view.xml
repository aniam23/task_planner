<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Vista Formulario -->
        <record id="activity_planner_details_view_form" model="ir.ui.view">
            <field name="name">task.board.details.form</field>
            <field name="model">task.board</field>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <group>
                            <group>
                                <field name="name" string="Nombre de la Tarea"/>
                                <field name="allowed_member_ids" invisible="1"/>
                                <field name="person" widget="many2one_avatar_user" string="Responsable"/>
                                <field name="state" widget="selection" string="Estado"/>
                                <field name="completion_date" string="Fecha"/>
                                <field name="files" widget="many2many_binary" string="Archivos"/>
                                <field name="has_dynamic_fields" invisible="1"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Tareas">
                                <field name="subtask_ids">
                                    <tree class="o_tree_view"
                                          decoration-danger="state == 'stuck'"
                                          decoration-warning="state == 'new'"
                                          decoration-info="state == 'in_progress'"
                                          decoration-success="state == 'done'">
                                       
                                        <field name="name" string="Nombre de La Tarea"/>
                                        <field name="person" widget="many2one_avatar_user" string="Responsable"/>
                                        <field name="state" widget="selection" string="Estado"/>
                                        <field name="completion_date" widget="daterange" string="Fecha"/>
                                        <button type="object" name="action_open_activity_tree" icon="fa-list" string="Ver Subtareas"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Vista para editar campos del kanban -->
        <record id="view_task_board_form" model="ir.ui.view">
            <field name="name">task.board.form</field>
            <field name="model">task.board</field>
            <field name="arch" type="xml">
                <form string="Editar Tarea">
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="name" string="Nombre" placeholder="Ingrese el nombre de la tarea"/>
                            </h1>
                        </div>
                        
                        <group>
                            <!-- Sección 1: Información básica -->
                            <group string="Información Básica" col="4">
                                <field name="person" string="Responsable" 
                                       widget="many2one_avatar_user"
                                       options="{'no_open': True}"
                                       context="{'search_default_active_employee': 1}"/>
                                <field name="state" string="Estado"/>
                                <field name="completion_date" string="Fecha Límite" widget="date"/>
                            </group>
                        
                            <!-- Sección 2: Progreso -->
                            <group string="Progreso" col="4">
                                <field name="progress" string="Progreso (%)" widget="progressbar" options="{'edit': true}"/>
                                <field name="completed_subtasks" string="Subtareas completadas"/>
                                <field name="total_subtasks" string="Total subtareas"/>
                                <field name="show_subtasks" string="Mostrar subtareas"/>
                            </group>
                            
                            <!-- Campos ocultos necesarios -->
                            <field name="allowed_member_ids" invisible="1"/>
                            <field name="has_dynamic_fields" invisible="1"/>
                            
                            <!-- Sección dinámica -->
                            <group string="Campos Adicionales" attrs="{'invisible': [('has_dynamic_fields', '=', False)]}" col="4">
                                <!-- Espacio para campos dinámicos -->
                            </group>
                        </group>
                    </sheet>
                    
                    <footer>
                        <button name="action_save" string="Guardar" type="object" class="btn-primary"/>
                        <button string="Cancelar" special="cancel" class="btn-secondary"/>
                    </footer>
                </form>
            </field>
        </record>

        <!-- Vista para crear campos dinámicos -->
        <record id="view_task_board_dynamic_fields_form" model="ir.ui.view">
            <field name="name">task.board.dynamic.fields.form</field>
            <field name="model">task.board</field>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <group>
                            <field name="name" 
                                   string="Nombre de la Tarea"
                                   attrs="{'invisible': [('apply_to_specific_task','=',False)]}"
                                   help="Select specific task for this field"/>

                            <field name="apply_to_specific_task" 
                                   string="Agregar a este grupo" 
                                   widget="boolean"/>

                            <field name="dynamic_field_name" 
                                string="Nombre Tecnico" 
                                help="Internal field name (e.g. x_priority)"/>
                        
                            <field name="dynamic_field_label" 
                                   string="Nombre del Campo" 
                                   required="1"
                                   help="Label visible to users"/>
                        
                            <field name="dynamic_field_type" 
                                   string="Tipo de Campo" 
                                   required="1"
                                   widget="radio"
                                   options="{'horizontal': true}"/>
                        
                        </group>
                    </sheet>
                    <footer>
                        <button name="action_create_dynamic_field" 
                                string="Guardar" 
                                type="object" 
                                class="btn-primary"/>
                        <button string="Cancelar" 
                                special="cancel" 
                                class="btn-secondary"/>
                    </footer>
                </form>
            </field>
        </record>
        <!-- Vista de árbol para subtareas -->
        <record id="view_subtask_tree" model="ir.ui.view">
            <field name="name">subtask.board.tree</field>
            <field name="model">subtask.board</field>
            <field name="arch" type="xml">
                <tree create="false" string="Tareas" 
                      decoration-danger="state == 'stuck'"
                      decoration-warning="state == 'new'"
                      decoration-info="state == 'in_progress'"
                      decoration-success="state == 'done'">
                    <field name="sequence" widget="handle" string="Secuencia"/>
                    <field name="name" string="Nombre de la tarea"/>
                    <field name="person" widget="many2one_avatar_user" string="Responsable"  context="{'search_default_allowed_member_ids': True}"/>
                    <field name="state" widget="selection" string="Estado"/>
                    <field name="completion_date" widget="daterange" string="Fecha"/>
                    <button name="action_open_activity_tree" type="object" icon="fa-eye" string="Ver Subtareas"/>
                    <button name="action_custom_create_subtask" 
                        type="object" 
                        string="Nueva Tarea" 
                        class="btn-primary" 
                        icon="fa-plus"/>
                </tree>
            </field>
        </record>

        <!-- Vista Kanban -->
        <record id="activity_planner_task_view_kanban" model="ir.ui.view">
            <field name="name">task.board.kanban</field>
            <field name="model">task.board</field>
            <field name="priority">10</field>
            <field name="arch" type="xml">
                <kanban create="false" edit="true" default_group_by="person" class="o_kanban_full_width" t-as="record">
                    <field name="id"/>
                    <field name="name"/>
                    <field name="person"/>
                    <field name="state"/>
                    <field name="progress"/>
                    <field name="completed_subtasks"/>
                    <field name="total_subtasks"/>
                    <field name="completion_date"/>
                    <field name="show_subtasks"/>
                    <field name="subtask_ids"/>
                    <field name="has_dynamic_fields" invisible="1"/>
                
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_global_click o_kanban_record" style="background: transparent;">
                                <div class="o_kanban_record_body">
                                    <div class="kanban_header">
                                        <strong><field name="name"/></strong>
                                        <button type="object" name="action_open_edit_form" string="Editar" class="btn btn-sm btn-link float-right" icon="fa-pencil"/>
                                    </div>
                                
                                    <table class="kanban_table">
                                        <thead>
                                            <tr>
                                                <th>Responsable</th>
                                                <th>Estado</th>
                                                <th>Progreso</th>
                                                <th>Fecha</th>
                                                <th>Opciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><field name="person" widget="many2one_avatar_user"/></td>
                                                <td><field name="state" widget="badge"/></td>
                                                <td>
                                                    <field name="progress" widget="progressbar" options="{'max_value': 100, 'height': '10px'}"/>
                                                    <small class="text-muted">
                                                        <field name="completed_subtasks"/>/<field name="total_subtasks"/>
                                                    </small>
                                                </td>
                                                <td><field name="completion_date" widget="daterange"/></td>
                                                <td style="border: 1px solid #dee2e6;">
                                                    <button type="object" 
                                                            class="btn btn-primary btn-sm" 
                                                            name="action_view_subtasks" 
                                                            string="Ver Subtareas"/>
                                                </td>
                                                <td style="border: 1px solid #dee2e6;">
                                                    <button name="action_open_dynamic_field_creator" 
                                                        string="Agregar Campo" 
                                                        type="object"
                                                        class="oe_highlight"/>

                                                    <button name="action_remove_dynamic_field" 
                                                        string="Eliminar Campo" 
                                                        type="object"
                                                        class="oe_highlight"/>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <!-- Tabla de subtareas condicional -->
                                    <tbody>
                                        <t t-if="record.show_subtasks.raw_value">
                                            <div class="mt-3">
                                                <h6>Tareas:</h6>
                                                <t t-set="subtasks" t-value="record.subtask_ids.raw_value || []"/>
                                                <t t-if="subtasks.length">
                                                    <table class="table table-sm table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>Nombre</th>
                                                                <th>Responsable</th>
                                                                <th>Estado</th>
                                                                <th>Acciones</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <t t-foreach="subtasks" t-as="subtask">
                                                                <tr>
                                                                    <td>
                                                                        <span t-esc="subtask.name"/>
                                                                    </td>
                                                                    <td>
                                                                        <t t-if="subtask.person">
                                                                            <span t-esc="subtask.person[1]"/> <!-- Nombre del responsable -->
                                                                        </t>
                                                                    </td>
                                                                    <td>
                                                                        <span t-esc="subtask.state"/>
                                                                    </td>
                                                                    <td>
                                                                         <button name="action_open_activity_tree" type="object" icon="fa-eye" string="Ver Subtareas"/>
                                                                    </td>
                                                                </tr>
                                                            </t>
                                                        </tbody>
                                                    </table>
                                                </t>
                                                <t t-else="">
                                                    <div class="alert alert-info mt-2">No hay subtareas para mostrar</div>
                                                </t>
                                            </div>
                                        </t>
                                    </tbody>
                                </div>
                            </div>
            
                            <style>
                                .o_kanban_dashboard .o_kanban_record {
                                    width: 500%;
                                    min-width: 450px;
                                    margin-bottom: 16px;
                                }
                                .kanban_table {
                                    width: 500%;
                                    border-collapse: collapse;
                                }
                                .kanban_table th, .kanban_table td {
                                    padding: 8px;
                                    border: 1px solid #dee2e6;
                                }
                                .kanban_table th {
                                    background-color: #f8f9fa;
                                    text-align: left;
                                }
                                .kanban_actions button {
                                    margin: 0 2px;
                                }
                                .o_form_label {
                                    font-weight: normal;
                                    margin-bottom: 0;
                                }
                                .kanban_header {
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    padding: 8px;
                                    background-color: #f8f9fa;
                                    border-bottom: 1px solid #dee2e6;
                                }
                            </style>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Acción de ventana -->
        <record id="task_planner.activity_tasks_action" model="ir.actions.act_window">
            <field name="name">Tasks Board</field>
            <field name="res_model">task.board</field>
            <field name="view_mode">kanban,form</field>
            <field name="view_id" ref="activity_planner_task_view_kanban"/>
            <field name="domain">[('department_id', '=', active_id)]</field>
            <field name="target">current</field>
            <field name="context">{'default_department_id': active_id}</field>
        </record>
    </data>
</odoo>
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Vista Formulario -->
        <record id="activity_planner_details_view_form" model="ir.ui.view">
            <field name="name">task.board.details.form</field>
            <field name="model">task.board</field>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <group>
                            <group>
                                <field name="name" string="Nombre de la Tarea"/>
                                <field name="allowed_member_ids" invisible="1"/>
                                <field name="person" widget="many2one_avatar_user" string="Responsable"/>
                                <field name="state" widget="selection" string="Estado"/>
                                <field name="completion_date" string="Fecha"/>
                                <field name="files" widget="many2many_binary" string="Archivos"/>
                                <field name="has_dynamic_fields" invisible="1"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Tareas">
                                <field name="subtask_ids">
                                    <tree class="o_tree_view"
                                          decoration-danger="state == 'stuck'"
                                          decoration-warning="state == 'new'"
                                          decoration-info="state == 'in_progress'"
                                          decoration-success="state == 'done'">
                                        <field name="drag" widget="handle" string="Sequencia"/>
                                        <field name="name" string="Nombre de La Tarea"/>
                                        <field name="person" widget="many2one_avatar_user" string="Responsable"/>
                                        <field name="state" widget="selection" string="Estado"/>
                                        <field name="completion_date" widget="daterange" string="Fecha"/>
                                        <button type="object" name="action_open_activity_tree" icon="fa-list" string="Ver Subtareas"/>
                                    </tree>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Vista para editar campos del kanban -->
        <record id="view_task_board_form" model="ir.ui.view">
            <field name="name">task.board.form</field>
            <field name="model">task.board</field>
            <field name="arch" type="xml">
                <form string="Edit Task">
                    <sheet>
                        <group>
                            <field name="name" string="Nombre de la Tarea"/>
                            <field name="allowed_member_ids" invisible="1"/>
                            <field name="person" string="Responsable" widget="many2one_avatar_user" context="{'search_default_active_employee': 1}"/>
                            <field name="state" string="Estado"/>
                            <field name="progress" string="Progreso"/>
                            <field name="completed_subtasks" string="Completed Subtasks"/>
                            <field name="total_subtasks" string="Total Subtasks"/>
                            <field name="completion_date" string="Fecha" widget="date"/>
                            <field name="show_subtasks" string="Show Subtasks"/>
                            <field name="has_dynamic_fields" invisible="1"/>
                            <group string="Dynamic Fields" attrs="{'invisible': [('has_dynamic_fields', '=', False)]}">
                            </group>
                        </group>
                    </sheet>
                    <footer>
                        <button name="action_save" string="Guardar" type="object" class="btn-primary"/>
                        <button string="Cancelar" special="cancel" class="btn-secondary"/>
                    </footer>
                </form>
            </field>
        </record>

        <!-- Vista para crear campos dinámicos -->
        <record id="view_task_board_dynamic_fields_form" model="ir.ui.view">
            <field name="name">task.board.dynamic.fields.form</field>
            <field name="model">task.board</field>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <group>
                            <field name="name" 
                                   string="Nombre de la Tarea"
                                   attrs="{'invisible': [('apply_to_specific_task','=',False)]}"
                                   help="Select specific task for this field"/>

                            <field name="apply_to_specific_task" 
                                   string="Agregar a este grupo" 
                                   widget="boolean"/>

                            <field name="dynamic_field_name" 
                                string="Nombre Tecnico" 
                                help="Internal field name (e.g. x_priority)"/>
                        
                            <field name="dynamic_field_label" 
                                   string="Nombre del Campo" 
                                   required="1"
                                   help="Label visible to users"/>
                        
                            <field name="dynamic_field_type" 
                                   string="Tipo de Campo" 
                                   required="1"
                                   widget="radio"
                                   options="{'horizontal': true}"/>
                        
                        </group>
                    </sheet>
                    <footer>
                        <button name="action_create_dynamic_field" 
                                string="Guardar" 
                                type="object" 
                                class="btn-primary"/>
                        <button string="Cancelar" 
                                special="cancel" 
                                class="btn-secondary"/>
                    </footer>
                </form>
            </field>
        </record>
        <!-- Vista de árbol para subtareas -->
        <record id="view_subtask_tree" model="ir.ui.view">
            <field name="name">subtask.board.tree</field>
            <field name="model">subtask.board</field>
            <field name="arch" type="xml">
                <tree string="Tareas" 
                      decoration-danger="state == 'stuck'"
                      decoration-warning="state == 'new'"
                      decoration-info="state == 'in_progress'"
                      decoration-success="state == 'done'">
                    <field name="sequence" widget="handle" string="Secuencia"/>
                    <field name="name" string="Nombre de la tarea"/>
                    <field name="person" widget="many2one_avatar_user" string="Responsable" context="{'search_default_active_employee': 1}"/>
                    <field name="state" widget="selection" string="Estado"/>
                    <field name="completion_date" widget="daterange" string="Fecha"/>
                    <button name="action_open_activity_tree" type="object" icon="fa-eye" string="Ver Subtareas"/>
                </tree>
            </field>
        </record>

        <!-- Vista Kanban -->
        <record id="activity_planner_task_view_kanban" model="ir.ui.view">
            <field name="name">task.board.kanban</field>
            <field name="model">task.board</field>
            <field name="priority">10</field>
            <field name="arch" type="xml">
                <kanban edit="true" default_group_by="show_subtasks" style="background: transparent;" class="o_kanban_full_width">
                    <field name="id"/>
                    <field name="name"/>
                    <field name="person"/>
                    <field name="state"/>
                    <field name="progress"/>
                    <field name="completed_subtasks"/>
                    <field name="total_subtasks"/>
                    <field name="completion_date"/>
                    <field name="show_subtasks"/>
                    <field name="has_dynamic_fields" invisible="1"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_global_click o_kanban_record" style="background: transparent;">
                                <div class="o_kanban_record">
                                    <div class="kanban_header">
                                        <strong><field name="name"/></strong>
                                        <button type="object" name="action_open_edit_form" string="Editar" class="btn btn-sm btn-link float-right" icon="fa-pencil"/>
                                    </div>
                                    <table class="kanban_table">
                                        <thead>
                                            <tr>
                                                <th class="o_form_label">Responsable</th>
                                                <th class="o_form_label">Estado</th>
                                                <th class="o_form_label">Progreso</th>
                                                <th class="o_form_label">Fecha</th>
                                                <th class="o_form_label">Opciones</th>
                                            </tr>
                                        </thead>
                                        <tbody style="background: transparent;">
                                            <tr>
                                                <td><field name="person" widget="many2one_avatar_user"/></td>
                                                <td>
                                                    <div t-attf-class="state_badge state_badge_{{record.state.value}}">
                                                        <field name="state" widget="badge"/>
                                                    </div>
                                                </td>
                                                <td>
                                                    <field name="progress" widget="progressbar" options="{'editable': true, 'input_type': 'number'}"/>
                                                    <small><field name="completed_subtasks"/>/<field name="total_subtasks"/></small>
                                                </td>
                                                <td><field name="completion_date" widget="date"/></td>
                                                <td>
                                                    <div class="kanban_actions">
                                                        <button type="object" name="action_view_subtasks" icon="fa-eye" class="btn-sm"/>
                                                        <button type="object" name="action_open_dynamic_field_creator" icon="fa-plus" class="btn-sm"/>
                                                        <button type="object" name="action_remove_dynamic_field" icon="fa-trash" class="btn-sm"/>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                           <style>

                                .o_kanban_group[data-name="drag"] .o_kanban_group_title {
                                color: transparent !important;
                                font-size: 0 !important;
                                padding: 0 !important;
                                margin: 0 !important;
                                height: 0 !important;
                                }

                                .o_kanban_group .o_kanban_group_title {
                                color: transparent !important;
                                font-size: 0 !important;
                                line-height: 0 !important;
                                height: 0 !important;
                                padding: 0 !important;
                                margin: 0 !important;
                                overflow: hidden !important;
                                }

                                /* Opcional: Ajusta el espaciado del grupo */
                                .o_kanban_group {
                                    padding-top: 4px !important;
                                }
                                .o_kanban_record {
                                    min-width: 450px;
                                    margin: 8px;
                                    padding: 0 !important;      
                                    background: transparent !important; 
                                    box-shadow: none !important; 
                                    border: none !important;     
                                }

                                .kanban_table {
                                    width: 600%;
                                    border-collapse: collapse;  
                                    background: white;  
                                }

                                .kanban_table th,
                                .kanban_table td {
                                    border: 1px solid #dee2e6 !important; 
                                    padding: 8px;
                                }

                                .kanban_table th {
                                    background-color: #f8f9fa !important;
                                }

                                .kanban_header {
                                    font-size: 16px;
                                    font-weight: bold;
                                    border: none !important;   
                                    padding: 0 0 8px 0;
                                    background: transparent !important;
                                }

                            </style>
                        </t> 
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Acción de ventana -->
        <record id="task_planner.activity_tasks_action" model="ir.actions.act_window">
            <field name="name">Tasks Board</field>
            <field name="res_model">task.board</field>
            <field name="view_mode">kanban,form</field>
            <field name="view_id" ref="activity_planner_task_view_kanban"/>
            <field name="domain">[('department_id', '=', active_id)]</field>
            <field name="target">current</field>
            <field name="context">{'default_department_id': active_id}</field>
        </record>
    </data>
</odoo>